# æ•°æ®è¯·æ±‚

Nuxt å†…ç½®äº† `useFetch`, `useLazyFetch`, `useAsyncData`, `useLazyAsyncData`  æ¥å¤„ç†åº”ç”¨ç¨‹åºçš„æ•°æ®è·å–ã€‚

::alert{icon=ğŸ‘‰}
**`useFetch`, `useLazyFetch`, `useAsyncData` å’Œ `useLazyAsyncData` åªèƒ½åœ¨ `setup` or `Lifecycle Hooks` ä¸­ä½¿ç”¨**
::

## `useFetch`

åœ¨ä½ çš„é¡µé¢ã€ç»„ä»¶å’Œæ’ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `useFetch` è¯·æ±‚ä»»ä½•URL,

è¿™ä¸ªç»„åˆæ˜¯å¯¹ `useAsyncData` å’Œ `$fetch` çš„å°è£…ï¼Œå®ƒæ ¹æ®URLå’Œ è¯·æ±‚çš„å‚æ•°è‡ªåŠ¨ç”Ÿæˆå¯†é’¥ï¼Œå¹¶æ¨æ–­APIçš„è¿”å›ç±»å‹ã€‚



::ReadMore{link="/api/composables/use-fetch"}
::

### ä¾‹å­ï¼š

```vue [app.vue]
<script setup>
const { data: count } = await useFetch('/api/count')
</script>

<template>
  Page visits: {{ count }}
</template>
```

:LinkExample{link="/examples/composables/use-fetch"}

## `useLazyFetch`

è¿™ä¸ªç»„åˆç­‰ä»·äº è®¾ç½®äº† `lazy:true`  çš„ `useFetch` ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå¼‚æ­¥å‡½æ•°ä¸ä¼šé˜»å¡å¯¼èˆªï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦å¤„ç†æ•°æ®ä¸º `null` çš„æƒ…å†µï¼Œï¼ˆæˆ–è€…åœ¨å·¥å‚å‡½æ•°ä¸­è‡ªå®šä¹‰é»˜è®¤å€¼ï¼‰ã€‚


::ReadMore{link="/api/composables/use-lazy-fetch"}
::

### ä¾‹å­ï¼š

```vue
<template>
  <!-- you'll need to handle a loading state -->
  <div v-if="pending">
    Loading ...
  </div>
  <div v-else>
    <div v-for="post in posts">
      <!-- do something -->
    </div>
  </div>
</template>

<script setup>
const { pending, data: posts } = useLazyFetch('/api/posts')
watch(posts, (newPosts) => {
  // Because posts starts out null, you won't have access
  // to its contents immediately, but you can watch it.
})
</script>
```

## `useAsyncData`

åœ¨é¡µé¢ï¼Œç»„ä»¶å’Œæ’ä»¶ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ `useAsyncData`è®¿é—®å¼‚æ­¥è§£æçš„æ•°æ®ã€‚

::alert
ä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼š`useFetch` å’Œ `useAsyncData`çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
ç®€å•çš„è¯´ï¼Œ`useFetch` æ¥æ”¶ä¸€ä¸ªURLä½œä¸ºå‚æ•°æ¥è·å–æ•°æ®ï¼Œè€Œ`useSyncData` å¯èƒ½å…·æœ‰æ›´å¤šçš„é€»è¾‘ã€‚ `useFetch(url)`ç­‰åŒäº `useAsyncData(url,()=>$fetch(url))`- é€šå¸¸æƒ…å†µä¸‹ï¼Œæœ‰åˆ©äºå¼€å‘ä½“éªŒã€‚

::

::ReadMore{link="/api/composables/use-async-data"}
::

### ä¾‹å­

```ts [server/api/count.ts]
let counter = 0
export default () => {
  counter++
  return JSON.stringify(counter)
}
```

```vue [app.vue]
<script setup>
const { data } = await useAsyncData('count', () => $fetch('/api/count'))
</script>

<template>
  Page visits: {{ data }}
</template>
```

:LinkExample{link="/examples/composables/use-async-data"}

## `useLazyAsyncData`

è¿™ä¸ªç»„åˆå‡½æ•°ç­‰ä»·äºï¼Œè®¾ç½®äº† `lazy:true` çš„`useAsyncData` . æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªå¼‚æ­¥å‡½æ•°ä¸ä¼šé˜»å¡å¯¼èˆªï¼Œç€æ„å‘³ç€ä½ éœ€è¦å¤„ç† data ä¸º `null` çš„æƒ…å†µï¼Œï¼ˆæˆ–è€…åœ¨å·¥å‚å‡½æ•°ä¸­è‡ªå®šä¹‰é»˜è®¤å€¼ï¼‰ã€‚


::ReadMore{link="/api/composables/use-lazy-async-data"}
::

### ä¾‹å­ï¼š

```vue
<template>
  <div>
    {{ pending ? 'Loading' : count }}
  </div>
</template>

<script setup>
const { pending, data: count } = useLazyAsyncData('count', () => $fetch('/api/count'))
watch(count, (newCount) => {
  // Because count starts out null, you won't have access
  // to its contents immediately, but you can watch it.
})
</script>
```

## åˆ·æ–°æ•°æ®


æœ‰æ—¶ï¼Œç”¨æˆ·åœ¨æµè§ˆé¡µé¢çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥èƒ½è¦åˆ·æ–°ä»APIåŠ è½½çš„æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨é€‰æ‹©åˆ†é¡µï¼Œè¿‡æ»¤ç»“æœï¼Œæœç´¢ç­‰ç­‰æƒ…å†µã€‚

ä½ å¯ä»¥ä½¿ç”¨`refresh()` æ–¹æ³• æ¥åˆ·æ–° `useFetch()`ä¸­æ ¹æ®ä¸åŒå‚æ•°è¿”å›çš„æ•°æ®ã€‚


```vue
<script setup>
const page = ref(1);

const { data: users, pending, refresh, error } = await useFetch(() => `users?page=${page.value}&take=6`, { baseURL: config.API_BASE_URL }
);

function previous(){
  page.value--;
  refresh();
}

function next() {
  page.value++;
  refresh();
}
</script>
```

è¿™é‡Œçš„å…³é”®æ˜¯ï¼Œä¿®æ”¹ `useFetch()` ä½¿ç”¨çš„å‚æ•°åè°ƒç”¨`refresh()`

### `refreshNuxtData`

æƒ³è¦è®© `useAsyncData` `useLazyAsyncData` `useFetch` `useLazyFetch` çš„ç¼“å†²å¤±æ•ˆï¼Œå¹¶è§¦å‘é‡æ–°è¯·æ±‚ã€‚

å½“ä½ æƒ³è¦åˆ·æ–°å½“å‰é¡µé¢æ‰€æœ‰çš„æ•°æ®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚


::ReadMore{link="/api/utils/refresh-nuxt-data"}
::

### ä¾‹å¦‚ï¼š

```vue
<template>
  <div>
    {{ pending ? 'Loading' : count }}
  </div>
  <button @click="refresh">Refresh</button>
</template>

<script setup>
const { pending, data: count } = useLazyAsyncData('count', () => $fetch('/api/count'))

const refresh = () => refreshNuxtData('count')
</script>
```

## åŒæ„ `fetch` å’Œ `$fetch`

å½“æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è°ƒç”¨ `fetch` æ—¶ï¼Œåƒ`cookie` è¿™æ ·çš„ç”¨æˆ·header ä¿¡æ¯ä¼šç›´æ¥å‘é€ç»™APIï¼Œä½†æ˜¯å½“æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œï¼Œç”±äº`fetch`è¯·æ±‚æ—¶åœ¨æœåŠ¡ç«¯å†…éƒ¨ï¼Œå› æ­¤å®ƒä¸åŒ…æ‹¬ç”¨æˆ·æµè§ˆå™¨ç«¯çš„cookies,ä¹Ÿä¸ä»fetchå“åº”ä¼ é€’cookieã€‚

::ReadMore{link="/api/utils/$fetch"}
::

### ä¾‹å­: ç»™APIå‘é€header ä¿¡æ¯

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨  [`useRequestHeaders`](/api/composables/use-request-headers) ä»æœåŠ¡ç«¯è®¿é—®å¹¶ä»£ç†cookieç»™API

ä¸‹é¢çš„ä¾‹å­å°†è¯·æ±‚header ä¿¡æ¯æ·»åŠ åˆ°åŒæ„çš„`$fetch`è°ƒç”¨ä¸­ï¼Œæ¥ç¡®ä¿APIç«¯å¯ä»¥è®¿é—®ç”±ç”¨æˆ·ç«¯å‘é€æ¥çš„ `cookie`.


```vue
<script setup>
const { data } = await useFetch('/api/me', {
  headers: useRequestHeaders(['cookie'])
})
</script>
```

::alert{type="warning"}
åœ¨å°†headerä»£ç†åˆ°å¤–éƒ¨APiå‰è¦å°å¿ƒä½¿ç”¨ï¼ŒåªåŒ…å«ä½ éœ€è¦çš„å¤´éƒ¨ä¿¡æ¯ï¼Œ
ä¸æ˜¯æ‰€æœ‰çš„headerä¿¡æ¯éƒ½å¯ä»¥å®‰å…¨ä¼ é€’ï¼Œä¹Ÿæœ‰å¯èƒ½å¼•èµ·ä¸ç¡®å®šçš„é—®é¢˜ã€‚

ä¸‹é¢åˆ—å‡ºäº†å¸¸è§çš„ä¸éœ€è¦ä»£ç†çš„headerä¿¡æ¯ã€‚
* `host`, `accept`
* `content-length`, `content-md5`, `content-type`
* `x-forwarded-host`, `x-forwarded-port`, `x-forwarded-proto`
* `cf-connecting-ip`, `cf-ray`
::

### ä¾‹å­: åœ¨æœåŠ¡ç«¯APIè°ƒç”¨æ—¶ï¼Œä¼ é€’Cookie
å¦‚æœä½ æƒ³è¦ä»å†…éƒ¨è¯·æ±‚å‘å®¢æˆ·ç«¯ä¼ é€’æˆ–è€…ä»£ç† cookieï¼Œä½ éœ€è¦è‡ªå·±å¤„ç†è¿™ç§æƒ…å†µ

```ts [composables/fetch.ts]
export const fetchWithCookie = async (url: string, cookieName: string) => {
  const response = await $fetch.raw(url)
  if (process.server) {
    const cookies = Object.fromEntries(
      response.headers.get('set-cookie')?.split(',').map((a) => a.split('='))
    )
    if (cookieName in cookies) {
      useCookie(cookieName).value = cookies[cookieName]
    }
  }
  return response._data
}
```

```vue
<script setup lang="ts">
// This composable will automatically pass on a cookie of our choice.
const result = await fetchWithCookie("/api/with-cookie", "test")
onMounted(() => console.log(document.cookie))
</script>
```

## æœ€ä½³å®è·µ

è¿™äº›ç»„åˆé¡¹è¿”å›çš„æ•°æ®ä¼šè¢«å­˜å‚¨åœ¨é¡µé¢è´Ÿè½½å†…ï¼Œè¿™æ„å‘³ç€è¿”å›çš„æ¯ä¸ªæœªåœ¨ç»„ä»¶ä¸­ä½¿ç”¨çš„key éƒ½ä¼šè¢«æ·»åŠ åˆ°è´Ÿè½½ä¸­ã€‚


::alert{icon=ğŸ‘‰}
**æˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½ ï¼Œåªé€‰æ‹©ç»„ä»¶ä¸­ç”¨åˆ°çš„key.**
::

åŠ å…¥ `/api/mountains/everest` è¿”å›ä¸‹é¢çš„å¯¹è±¡ï¼š

```json
{
  "title": "Mount Everest",
  "description": "Mount Everest is Earth's highest mountain above sea level, located in the Mahalangur Himal sub-range of the Himalayas. The Chinaâ€“Nepal border runs across its summit point",
  "height": "8,848 m",
  "countries": [
    "China",
    "Nepal"
  ],
  "continent": "Asia",
  "image": "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f6/Everest_kalapatthar.jpg/600px-Everest_kalapatthar.jpg"
}
```

å¦‚æœä½ åªæ‰“ç®—åœ¨ä½ çš„ç»„ä»¶ä¸­ä½¿ç”¨`title` `description` ä½ å¯ä»¥é€šè¿‡`$fetch` æˆ–è€… `pick` é“¾å¼è°ƒç”¨ é€‰å‡ºä½ æƒ³è¦çš„keyï¼š

```vue
<script setup>
const { data: mountain } = await useFetch('/api/mountains/everest', { pick: ['title', 'description'] })
</script>

<template>
  <h1>{{ mountain.title }}</h1>
  <p>{{ mountain.description }}</p>
</template>
```

## ä½¿ç”¨å¼‚æ­¥ setup

å¦‚æœä½ æƒ³ä½¿ç”¨`async setup()`,å½“å‰çš„ç»„ä»¶å®åŠ›ä¼šåœ¨ç¬¬ä¸€ä¸ª`await`åæ¶ˆå¤±ï¼Œï¼ˆè¿™æ˜¯Vue3çš„é™åˆ¶ï¼‰å¦‚æœä½ æƒ³ä½¿ç”¨å¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚å¤šæ¬¡è°ƒç”¨ `useFetch`ï¼Œä½ ä¼šéœ€è¦ä½¿ç”¨ `<script setup>` æˆ–è€…åœ¨setupæœ«å°¾ç­‰å¾…å®ƒä»¬ä¸€èµ·æ‰§è¡Œã€‚


::alert{icon=ğŸ‘‰}
æ¨èä½¿ç”¨`<script setup>` å®ƒé¿å…äº†é¡¶å±‚ä½¿ç”¨awaitçš„é™åˆ¶ï¼Œ[é˜…è¯»æ›´å¤š](https://vuejs.org/api/sfc-script-setup).
::

```vue
<script>
export default defineComponent({
  async setup() {
    const [{ data: organization }, { data: repos }] = await Promise.all([
      useFetch(`https://api.github.com/orgs/nuxt`),
      useFetch(`https://api.github.com/orgs/nuxt/repos`)
    ])

    return {
      organization,
      repos
    }
  }
})
</script>

<template>
  <header>
    <h1>{{ organization.login }}</h1>
    <p>{{ organization.description }}</p>
  </header>
</template>
```

## ç›´æ¥è°ƒç”¨API

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½éœ€è¦ç›´æ¥è°ƒç”¨APIï¼ŒNuxt3æä¾›äº†ä¸€ä¸ªå…¨å±€å¯ç”¨çš„`$fetch`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨[unjs/ohmyfetch](https://github.com/unjs/ohmyfetch)ï¼ˆé™¤`fetch`å¤–ï¼‰ï¼Œå®ƒçš„APIå’Œ[åŸç”Ÿfetch](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch)ä¸€æ ·ã€‚

`$fetch`æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š
åœ¨æœåŠ¡å™¨ç«¯å®ƒä¼šæ™ºèƒ½å¾—å¤„ç†ç›´æ¥è°ƒç”¨APIï¼Œå¦‚æœè¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼Œå®ƒä¼šå¯¹ä½ çš„APIè¿›è¡Œè°ƒç”¨ï¼Œï¼ˆå®ƒè¿˜å¯ä»¥å¤„ç†è°ƒç”¨ç¬¬ä¸‰æ–¹APIï¼‰
æ­¤å¤–ï¼Œå®ƒè¿˜å…·æœ‰æ–¹ä¾¿çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è‡ªåŠ¨è§£æå“åº”å’Œå­—ç¬¦ä¸²åŒ–æ•°æ®ã€‚
